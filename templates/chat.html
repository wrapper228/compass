<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Compass Chat</title>
    <style>
      :root{color-scheme:light dark}
      body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; max-width: 840px; margin: 24px auto; padding: 0 12px}
      h1{margin:0 0 16px}
      #chat{border:1px solid #ddd; border-radius:10px; padding:12px; height:60vh; overflow:auto; background:#fafafa}
      .row{display:flex; gap:8px; margin-top:12px}
      input[type=text]{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #ccc}
      button{padding:10px 14px; border-radius:10px; border:1px solid #ccc; cursor:pointer}
      .bubble{max-width:80%; padding:10px 12px; border-radius:14px; margin:8px 0; white-space:pre-wrap}
      .user{background:#e8f0ff; margin-left:auto}
      .assistant{background:#e9ffe8; margin-right:auto}
      .meta{color:#666; font-size:12px}
    </style>
  </head>
  <body>
    <h1>Compass Chat</h1>
    <div id="chat"></div>
    <form id="send" class="row">
      <input id="text" type="text" placeholder="Напишите сообщение..." autocomplete="off" />
      <button type="submit">Отправить</button>
    </form>
    <div class="meta">Ответ стримится через WebSocket.</div>
    <script>
      const chatEl = document.getElementById('chat');
      const formEl = document.getElementById('send');
      const inputEl = document.getElementById('text');

      function appendBubble(text, who){
        const div = document.createElement('div');
        div.className = 'bubble ' + who;
        div.textContent = text;
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
        return div;
      }

      function wsUrl(path){
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        return proto + '://' + location.host + path;
      }

      formEl.addEventListener('submit', (e)=>{
        e.preventDefault();
        const text = inputEl.value.trim();
        if(!text) return;
        inputEl.value = '';
        appendBubble(text, 'user');
        const ws = new WebSocket(wsUrl('/api/ws/chat'));
        const assistant = appendBubble('', 'assistant');
        ws.onopen = ()=> ws.send(text);
        ws.onmessage = (ev)=>{
          if(ev.data === '[DONE]'){ ws.close(); return; }
          assistant.textContent += ev.data;
          chatEl.scrollTop = chatEl.scrollHeight;
        };
        ws.onerror = ()=>{ assistant.textContent = '(ошибка соединения)'; };
      });
    </script>
  </body>
  </html>


